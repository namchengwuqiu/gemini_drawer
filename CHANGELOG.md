# Gemini 绘图插件 更新日志


## v1.7.4～v1.7.5 (2026-01-22)

### 修复
- **防止 Action 重复触发**: 为绘图、自拍和视频 Action 添加"不要连续发"提示，帮助 Planner 避免在同一上下文中重复触发相同动作

---

## v1.7.3 (2026-01-22)

### 改进
- **自拍/视频 Action 智能化** 🧠
  - 现在可以从用户消息中提取完整的场景描述（包括服装、动作、场景等）
  - 例如：说"发个穿女仆装跳舞的视频"，系统会提取"穿女仆装跳舞"而不只是"跳舞"
  - 如果用户没有指定具体场景，则随机选择预设动作

### 修复
- **参数命名冲突修复**: 修复了 `action_parameters` 中的 `action` 键与 Planner 系统保留字段冲突导致动作无法正确触发的问题

### 文档
- 新增 NapCat HTTP 服务器配置说明（视频发送功能所需）

---

## v1.7.2 (2026-01-21)

### 新增功能
- **视频自拍功能** 🎬
  - 新增 `SelfieVideoAction` - 生成自己的视频
  - 支持通过自然语言触发（如"发个视频看看"、"来段视频"）
  - 随机选择视频动作，可配置 `selfie.video_actions`
  - 支持豆包和 OpenAI 格式的视频 API

---

## v1.7.1 (2026-01-20)

### 新增功能
- **豆包视频 API 支持** 🍫
  - 支持火山引擎豆包视频生成 API (`volces.com`)
  - 实现异步任务模式：创建任务 → 轮询状态 → 下载视频
  - 默认模型: `doubao-seedance-1-5-pro-251215`
  - 支持图生视频和文生视频

---

## v1.7.0 (2026-01-20)

### 新增功能
- **视频生成命令** 🎬
  - 新增 `/图生视频 <描述词>` 命令 - 图生视频，根据图片和文字描述生成视频
  - 新增 `/文生视频 <描述词>` 命令 - 纯文字生成视频，无需图片输入
  - 支持 OpenAI 和 Gemini 格式的视频生成 API
  - 新增渠道视频模式标识，可将指定渠道专用于视频生成
  - 通过 NapCat HTTP API 发送视频，使用 base64 格式避免 Docker 容器文件系统隔离问题
  - 合并图生视频和文生视频基类，通过 `requires_image` 属性控制模式

### 配置项
- 新增 `api.napcat_host` - NapCat HTTP 服务器地址（Docker 环境下设为 `napcat`）
- 新增 `api.napcat_port` - NapCat 正向 HTTP 端口（默认 3033）

### 管理员命令
- 新增 `/渠道设置视频 <渠道名> <true|false>` - 设置渠道是否用于视频生成
- `/渠道列表` 现在显示 `[视频]` 标签标识视频渠道

### 修复
- **渠道分离修复**: 修复了生图任务会错误调用视频渠道的问题，现在 `is_video=True` 的渠道只用于视频生成
- **视频重试逻辑**: 修复视频生成失败后未继续尝试下一个端点的问题

---

## v1.6.7 (2026-01-19)

### 修复
- **重定向处理修复**: 修复了 API 请求不跟随 3xx 重定向导致的 `Rediection response ...` 报错。现在所有请求都会自动跟随重定向。
- **URL提取逻辑优化**: 改进了从 API 响应中提取图片 URL 的逻辑。优先匹配带后缀的图片链接，并自动跳过 `dashboard` / `login` 等非图片 URL，解决了部分 API 返回登录页导致的误判。

## v1.6.6 (2026-01-16)

### 改进
- **渠道管理命令优化** 📋
  - `/渠道key列表` 现在以聊天记录格式发送，每个渠道单独一个消息节点
  - `/渠道列表` 现在以聊天记录格式发送，内置渠道和自定义渠道分组显示
  - 与 `/基咪绘图帮助` 保持一致的展示风格

---

## v1.6.5 (2026-01-16)

### 新增功能
- **自拍提示词润色** ✨: 为自拍功能添加提示词润色支持，在生成自拍前可使用 LLM 模型对随机动作进行润色优化，使提示词更适合图像生成。
  - 新增配置项 `selfie.polish_enable` - 是否启用润色（默认开启）
  - 新增配置项 `selfie.polish_model` - 使用的文本模型名称
  - 新增配置项 `selfie.polish_template` - 润色提示词模板

## v1.6.4 (2026-01-10)

### 新增功能
- **随机绘图命令** 🎲: 新增 `/随机` 或 `/随机绘图` 命令，从预设风格中随机抽取一个进行绘图，增加趣味性。

## v1.6.3 (2026-01-09)

### 修复
- **数据迁移修复**: 修复了旧版本数据文件（`data.json`/`data.js`）位于插件根目录时，更新可能导致数据丢失的问题。现在会自动迁移旧数据到 `data/` 目录并备份原文件。
- **版本号统一**: 修复了插件内部版本号不一致的问题。


## v1.6.2 (2026-01-07)

### 修复
- 修复了 自拍绘图结果图片无法发送的问题

### v1.6.1 (2026-01-05)

### 修复
- 修复了 指令（如 `/绘图`）可能会同时触发自然语言 Action 导致重复执行的问题

## v1.6.0 (2026-01-04)

### 新增功能
- **自拍功能** 📸 (Action 组件)
  - 新增“发自拍”能力，支持基于人设图和随机场景生成自拍
  - 支持自动创建配置目录和忽略 Git 追踪
- **自然语言绘图支持** (Action 组件) 🆕
  - 新增 `ImageGenerateAction` 组件
  - 支持通过自然语言（需配合具备意图识别能力的 Bot 模型）直接触发绘图
  - 例如："帮我画一张可爱的猫"、"画个赛博朋克风格的城市"
  - 复用现有的多渠道绘图配置，无需额外设置

### 修复
- 修复了 Action 组件的 ActivationType 错误和异步调用 awaiting 问题
- 修复了配置迁移时未保存的问题

---

## v1.5.2 (2025-12-29)

### 新增功能
- **多图生图命令** (`/多图`) 🆕
  - 新增 `/多图 <提示词>` 命令
  - 支持至少 2 张图片作为输入
  - 增强图片获取逻辑，支持从回复的消息中提取图片
  - 图片来源优先级：回复消息 > 当前消息图片 > @用户头像

---

## v1.5.1 (2025-12-28)

### 新增功能
- **删除渠道 Key** 🆕
  - 新增 `/渠道删除key <渠道> <序号>` 命令
  - 可删除指定渠道的特定 Key

- **豆包图生图支持**
  - 豆包 API 现在支持图生图功能（`/bnn`、`/+预设` 命令）
  - 自动检测是否有源图片，有则添加 `image` 参数

### 修复
- **API 响应解析修复**
  - 修复 `content` 为数组格式时无法提取图片的问题
  - 支持 `{"type": "image", "image": {"data": "..."}}` 格式
  - 支持 `{"type": "image_url", "image_url": {"url": "..."}}` 格式
  - 支持 `message.images` 数组格式（图片与 content 分离的响应）

### 改进
- **日志优化**
  - 使用 `safe_json_dumps` 自动截断 base64 数据
  - 避免日志中出现过长的图片数据

---

## v1.5.0 (2025-12-27)

### 新增功能
- **火山豆包 API 支持** 🆕
  - 新增对火山引擎豆包图片生成 API 的支持
  - 支持 `/images/generations` 端点格式
  - 支持 URL 返回和 base64 返回两种格式

### 改进
- **添加渠道命令优化**
  - 现在支持三种 API 格式：OpenAI、Gemini、豆包
  - 改进的格式验证和错误提示
  - 添加成功后显示 API 类型和下一步操作引导

### 代码重构
- 将插件拆分为多个模块文件，提高可维护性
- 为每个模块添加详细的文档注释

---

## v1.4.2 (2025-12-26)

### 改进
- **查看提示词命令优化**
  - 现在以聊天记录格式发送提示词内容（与 `/基咪绘图帮助` 一致）
  - 更清晰的内容展示

### 修复
- 修复帮助文本中无效转义序列 `\|` 的警告
- 更新默认 API 端点为 `gemini-3-pro-image`

---

## v1.4.1 (2025-12-24)

### 新增功能
- **回复图片模式** (`behavior.reply_with_image`)
  - 生成的图片以回复触发消息的方式发送
  - 开启后自动跳过成功通知（戳一戳/文字）
  - 默认开启
  
- **管理员专用模式** (`behavior.admin_only_mode`)
  - 开启后仅管理员可使用绘图功能
  - 非管理员触发时提示"⚠️ 管理员已关闭绘图功能"
  - 默认关闭

- **查看提示词命令** (`/查看提示词 名称`)
  - 查看指定提示词的完整内容

### 技术改进
- 使用直接构造 `DatabaseMessages` 对象的方式实现图片回复，避免数据库查询延迟问题

---

## v1.3.2 及更早版本

请参阅 README.md 中的历史功能说明。
